<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Brieven typen ‚Äì demo v7</title>
<style>
  :root{
    --bg:#f6fbff;
    --panel:#ffffff;
    --line:#e5e7eb;
    --ink:#0f172a;
    --accent:#3b82f6;
    --accent2:#22c55e;
    --btn-disabled:#cbd5e1;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background:var(--bg);
    color:var(--ink);
  }
  .ribbon{
    display:flex;
    gap:12px;
    align-items:center;
    padding:14px 16px;
    background:linear-gradient(90deg,#e0f2fe,#fde68a,#fbcfe8);
    border-bottom:1px solid var(--line);
  }
  .brand{
    font-weight:900;
    color:#1e293b;
    display:flex;
    align-items:center;
    gap:10px;
  }
  .brand .logo{font-size:24px}
  .subtitle{
    font-size:14px;
    color:#0f172a;
  }
  .container{
    max-width:1100px;
    margin:16px auto;
    padding:0 16px 20px;
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .panel{
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:16px;
    padding:14px;
    box-shadow:0 2px 6px rgba(0,0,0,.04);
  }

  /* Opdracht-knoppen */
  .levels{
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    margin-bottom:8px;
  }
  .levelBtn{
    border:0;
    border-radius:14px;
    padding:12px 16px;
    font-weight:900;
    font-size:16px;
    color:#fff;
    cursor:pointer;
    box-shadow:0 4px 12px rgba(0,0,0,.12);
  }
  .op1{background:linear-gradient(180deg,#34d399,#16a34a)}
  .op2{background:linear-gradient(180deg,#38bdf8,#0ea5e9)}
  .op3{background:linear-gradient(180deg,#fb923c,#f97316)}
  .op-active{
    outline:3px solid rgba(59,130,246,0.7);
  }

  .hint{color:#334155; font-size:14px; margin-bottom:6px;}

  .prompt-text{
    background:#f8fafc;
    border-radius:12px;
    border:1px dashed var(--line);
    padding:10px 12px;
    font-size:14px;
    white-space:pre-wrap;
  }

  /* Typvak met schriftpapier */
  .typeHeader{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
    margin-bottom:6px;
    flex-wrap:wrap;
  }
  .typeHeader h3{
    margin:0;
    font-size:18px;
    display:flex;
    align-items:center;
    gap:6px;
  }
  .editor{
    width:100%;
    min-height:260px;
    padding:14px 14px 14px 52px; /* ruimte voor rode marge links */
    border-radius:14px;
    border:3px solid #bfdbfe;
    font-size:18px;
    line-height:28px;
    resize:vertical;
    outline:none;
    color:var(--ink);
    /* Schriftpapier look */
    background:
      linear-gradient(to bottom,#e5e7eb 1px,transparent 1px) repeat-y,
      linear-gradient(to right,#fecaca 2px,transparent 2px) no-repeat;
    background-size:
      100% 28px,
      40px 100%;
    background-position:
      0 18px,
      34px 0;
    background-color:#ffffff;
  }
  .editor:focus{
    border-color:var(--accent);
    box-shadow:0 0 0 2px rgba(59,130,246,0.25);
  }

  /* Schermtoetsenbord */
  .kbd-toggle{
    margin-top:8px;
    font-size:14px;
    color:#475569;
  }
  .kbd{
    display:flex;
    flex-direction:column;
    gap:6px;
    margin-top:10px;
  }
  .row{display:flex; gap:6px}
  .key{
    flex:1;
    border:1px solid var(--line);
    background:#fff;
    border-radius:8px;
    padding:8px 0;
    text-align:center;
    user-select:none;
    font-weight:800;
    cursor:pointer;
    font-size:11px;
    white-space:pre-line;
  }
  .key.wide{flex:2}
  .key.space{flex:5}
  .key.hl{background:#e0f2fe; border-color:#3b82f6}

  .stats{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-top:10px;
    font-size:13px;
  }
  .stat-badge{
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--line);
    background:#f8fafc;
  }
  .stat-badge strong{font-weight:700}

  .buttons{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-top:10px;
    justify-content:flex-end;
  }
  .btn{
    padding:8px 12px;
    border-radius:999px;
    border:1px solid var(--line);
    background:#fff;
    cursor:pointer;
    font-weight:700;
  }
  .btn-main{
    border:none;
    background:linear-gradient(180deg,#22c55e,#16a34a);
    color:#fff;
    box-shadow:0 3px 8px rgba(34,197,94,0.4);
  }
  .btn:active{transform:translateY(1px)}

  .feedback{
    margin-top:6px;
    font-size:13px;
    color:#0f172a;
  }
  .feedback span.tag{
    display:inline-block;
    padding:2px 8px;
    border-radius:999px;
    font-size:12px;
    margin-right:6px;
    background:#eef2ff;
    color:#4338ca;
  }

  .issues{
    margin-top:6px;
    font-size:12px;
    color:#111827;
  }
  .issues ul{
    margin:4px 0 0;
    padding-left:18px;
  }
  .issues li{
    margin-bottom:2px;
  }

  /* Checklist onderaan */
  .checklist{
    margin-top:12px;
    padding:10px 12px;
    border-radius:12px;
    background:#ecfeff;
    border:1px solid #bae6fd;
    font-size:14px;
  }
  .checklist-title{
    font-weight:700;
    margin-bottom:6px;
  }
  .checklist ul{
    list-style:none;
    padding-left:0;
    margin:0;
  }
  .checklist li{
    display:flex;
    gap:6px;
    margin-bottom:4px;
    align-items:flex-start;
  }
  .checklist input[type="checkbox"]{
    margin-top:3px;
  }
</style>
</head>
<body>
  <div class="ribbon">
    <div class="brand">
      <span class="logo">‚úâÔ∏è</span>
      <span>Brieven typen ‚Äì demo</span>
    </div>
    <div class="subtitle">Schrijf en typ √©√©n brief, met schermtoetsenbord</div>
  </div>

  <div class="container">

    <!-- Bovenste panel: opdrachten + uitleg -->
    <div class="panel">
      <h3>Schrijfopdracht kiezen</h3>
      <div class="levels">
        <button class="levelBtn op1 op-active" data-op="vriend">Brief aan een vriend(in)</button>
        <button class="levelBtn op2" data-op="juf">Brief aan juf/meester</button>
        <button class="levelBtn op3" data-op="toekomst">Brief aan jezelf (later)</button>
      </div>

      <div class="hint">
        Kies een opdracht. Lees de punten en schrijf daarna jouw brief hieronder.
      </div>

      <div class="prompt-text" id="promptText">
Vertel in je brief:
‚Ä¢ Wie je bent en waar jullie elkaar van kennen.
‚Ä¢ Wat jouw leukste dag ooit was √≥f wat je lievelingshobby is.
‚Ä¢ Waarom je dat zo leuk vindt.
‚Ä¢ Wat je vriend(in) misschien ook eens zou moeten proberen.

Sluit af met een vriendelijke groet.
      </div>
    </div>

    <!-- Onderste panel: brief + toetsenbord + checklist -->
    <div class="panel">
      <div class="typeHeader">
        <h3>‚úèÔ∏è Jouw brief</h3>
      </div>

      <textarea id="letterText" class="editor"
        spellcheck="true" lang="nl"
        placeholder="Begin je brief bijvoorbeeld zo:
Beste ...

Schrijf daarna jouw verhaal."></textarea>

      <div class="kbd-toggle">
        <label>
          <input type="checkbox" id="showKeyboard">
          Schermtoetsenbord tonen
        </label>
      </div>

      <div class="kbd" id="keyboard" style="display:none">
        <div class="row" id="row0"></div>
        <div class="row" id="row1"></div>
        <div class="row" id="row2"></div>
        <div class="row" id="row3"></div>
        <div class="row" id="row4"></div>
      </div>

      <div class="stats">
        <div class="stat-badge">
          <strong>Woorden:</strong> <span id="wordCount">0</span>
        </div>
        <div class="stat-badge">
          <strong>Zinnen:</strong> <span id="sentenceCount">0</span>
        </div>
        <div class="stat-badge">
          <strong>Tekens:</strong> <span id="charCount">0</span>
        </div>
        <div class="stat-badge">
          <strong>Leestekens:</strong> <span id="punctCount">0</span>
        </div>
        <div class="stat-badge">
          <strong>Cijfer:</strong> <span id="grade">‚Äì</span> / 10
        </div>
      </div>

      <div class="buttons">
        <button class="btn" id="btnNew">Nieuwe brief üóëÔ∏è</button>
        <button class="btn btn-main" id="btnImage">Bewaar als plaatje üì∑</button>
      </div>

      <div class="feedback" id="feedback">
        <span class="tag">üéì Feedback</span>
        Let op hoofdletters en punten in elke zin.
      </div>

      <div class="issues" id="issues"></div>

      <!-- Checklist onderaan -->
      <div class="checklist">
        <div class="checklist-title">Checklist voor je brief</div>
        <ul>
          <li>
            <input type="checkbox" id="cl1">
            <label for="cl1">Ik begin met <strong>‚ÄúBeste ‚Ä¶‚Äù</strong> of <strong>‚ÄúHallo ‚Ä¶‚Äù</strong>.</label>
          </li>
          <li>
            <input type="checkbox" id="cl2">
            <label for="cl2">Ik vertel <strong>wie ik ben</strong> en <strong>waarom ik schrijf</strong>.</label>
          </li>
          <li>
            <input type="checkbox" id="cl3">
            <label for="cl3">Ik heb minstens <strong>5 zinnen</strong> geschreven.</label>
          </li>
          <li>
            <input type="checkbox" id="cl4">
            <label for="cl4">Ik gebruik <strong>hoofdletters</strong> en <strong>punten</strong>.</label>
          </li>
          <li>
            <input type="checkbox" id="cl5">
            <label for="cl5">Ik sluit af met <strong>‚ÄúGroetjes,‚Äù</strong> of <strong>‚ÄúMet vriendelijke groet,‚Äù</strong> + mijn naam.</label>
          </li>
        </ul>
      </div>
    </div>
  </div>

<script>
  // --- Schrijfopdrachten ---
  const prompts = {
    vriend: {
      key: "vriend",
      text:
`Vertel in je brief:
‚Ä¢ Wie je bent en waar jullie elkaar van kennen.
‚Ä¢ Wat jouw leukste dag ooit was √≥f wat je lievelingshobby is.
‚Ä¢ Waarom je dat zo leuk vindt.
‚Ä¢ Wat je vriend(in) misschien ook eens zou moeten proberen.

Sluit af met een vriendelijke groet.`
    },
    juf: {
      key: "juf",
      text:
`Vertel in je brief:
‚Ä¢ Wat je leuk vindt aan de klas.
‚Ä¢ Wat jij graag zou veranderen op school.
‚Ä¢ Waarom dat voor jou belangrijk is.
‚Ä¢ Een idee hoe jullie het samen beter kunnen maken.

Sluit netjes af en vergeet je naam niet.`
    },
    toekomst: {
      key: "toekomst",
      text:
`Vertel in je brief:
‚Ä¢ Wat je later graag wilt worden.
‚Ä¢ Hoe je hoopt dat je leven er dan uitziet.
‚Ä¢ Welke dromen je hebt (bijvoorbeeld werk, hobby, reizen).
‚Ä¢ Wat je jezelf wilt beloven.

Sluit af met een vrolijke zin voor jezelf.`
    }
  };

  let currentPromptKey = "vriend";

  const promptText = document.getElementById('promptText');
  const opButtons = document.querySelectorAll('.levelBtn');

  opButtons.forEach(btn=>{
    btn.addEventListener('click',()=>{
      opButtons.forEach(b=>b.classList.remove('op-active'));
      btn.classList.add('op-active');
      const key = btn.dataset.op;
      currentPromptKey = key;
      const info = prompts[key];
      promptText.textContent = info.text;
      updateStats();
    });
  });

  // --- Schermtoetsenbord ---
  const keyboard = document.getElementById('keyboard');
  const showKeyboard = document.getElementById('showKeyboard');
  const letterText = document.getElementById('letterText');
  let shiftOn = false;
  let shiftKeys = [];

  showKeyboard.addEventListener('change',e=>{
    keyboard.style.display = e.target.checked ? 'block' : 'none';
  });

  (function buildKeyboard(){
    const rows=[
      {id:'row0',keys:["1","2","3","4","5","6","7","8","9","0","-","="]},
      {id:'row1',keys:["q","w","e","r","t","y","u","i","o","p","[","]","\\"]},
      {id:'row2',keys:["a","s","d","f","g","h","j","k","l",";","'"]},
      {id:'row3',keys:["Shift","z","x","c","v","b","n","m",",",".","/","Shift"]},
      {id:'row4',keys:["Ctrl","Space","Enter","Backspace"]}
    ];
    rows.forEach(r=>{
      const row=document.getElementById(r.id);
      r.keys.forEach(k=>{
        let dkey=k;
        let label=k;

        if(k==="Space"){
          dkey=" ";
          label="‚éµ Spatie";
        }else if(k==="Enter"){
          dkey="\n";
          label="‚Üµ Enter";
        }else if(k==="Backspace"){
          dkey="Backspace";
          label="‚å´ Backspace";
        }else if(k==="Shift"){
          dkey="Shift";
          label="‚áß Shift";
        }else if(k==="Ctrl"){
          dkey="Ctrl";
          label="Ctrl";
        }else if(/[0-9]/.test(k)){
          const top =
            k==="1" ? "!" :
            k==="2" ? "@" :
            k==="3" ? "#" :
            k==="4" ? "‚Ç¨" :
            k==="5" ? "%" :
            k==="6" ? "^" :
            k==="7" ? "&" :
            k==="8" ? "*" :
            k==="9" ? "(" :
            k==="0" ? ")" : "";
          label = top ? top+"\n"+k : k;
        }else if(k.length===1 && k>="a" && k<="z"){
          label=k.toUpperCase();
        }

        const key=document.createElement('div');
        key.className='key';
        key.dataset.key=dkey;
        key.textContent=label;
        if(k==='Space') key.classList.add('space');
        if(k==='Enter' || k==='Backspace' || k==="Shift" || k==="Ctrl") key.classList.add('wide');
        key.addEventListener('click',()=> virtualKeyPress(dkey));
        row.appendChild(key);

        if(dkey==="Shift"){
          shiftKeys.push(key);
        }
      });
    });
  })();

  function setShiftActive(on){
    shiftOn=on;
    shiftKeys.forEach(k=>{
      if(on) k.classList.add('hl');
      else k.classList.remove('hl');
    });
  }

  function virtualKeyPress(dkey){
    if(dkey==="Shift"){
      setShiftActive(!shiftOn);
      return;
    }
    if(dkey==="Ctrl") return; // alleen uiterlijk

    letterText.focus();
    const start=letterText.selectionStart;
    const end=letterText.selectionEnd;
    let val=letterText.value;
    let insert="";

    if(dkey==="Backspace"){
      if(start===end && start>0){
        letterText.value = val.slice(0,start-1)+val.slice(end);
        letterText.selectionStart=letterText.selectionEnd=start-1;
      }else{
        letterText.value = val.slice(0,start)+val.slice(end);
        letterText.selectionStart=letterText.selectionEnd=start;
      }
    }else{
      if(dkey==="\n"){
        insert="\n";
      }else if(dkey.length===1 && dkey>="a" && dkey<="z"){
        insert = shiftOn ? dkey.toUpperCase() : dkey;
      }else if(/[0-9]/.test(dkey) && shiftOn){
        insert =
          dkey==="1" ? "!" :
          dkey==="2" ? "@" :
          dkey==="3" ? "#" :
          dkey==="4" ? "‚Ç¨" :
          dkey==="5" ? "%" :
          dkey==="6" ? "^" :
          dkey==="7" ? "&" :
          dkey==="8" ? "*" :
          dkey==="9" ? "(" :
          dkey==="0" ? ")" :
          dkey;
      }else if(dkey==="/" && shiftOn){
        insert="?";
      }else{
        insert=dkey;
      }
      letterText.value = val.slice(0,start)+insert+val.slice(end);
      letterText.selectionStart=letterText.selectionEnd=start+insert.length;
    }

    if(shiftOn && dkey!=="Shift"){
      setShiftActive(false);
    }

    letterText.dispatchEvent(new Event('input'));
  }

  // --- Stats + streng cijfer + issues ---
  const wordCount = document.getElementById('wordCount');
  const sentenceCount = document.getElementById('sentenceCount');
  const charCount = document.getElementById('charCount');
  const punctCount = document.getElementById('punctCount');
  const gradeEl = document.getElementById('grade');
  const feedback = document.getElementById('feedback');
  const issuesBox = document.getElementById('issues');

  function analyzeSentences(text){
    const trimmed = text.trim();
    if(trimmed.length === 0) return [];

    const rawSents = trimmed.match(/[^.!?]+[.!?]?/g) || [];
    const sentences = [];
    rawSents.forEach(raw=>{
      const s = raw.trim();
      if(!s) return;
      sentences.push(s);
    });
    return sentences;
  }

  function buildIssues(text){
    const issues = [];
    const sentences = analyzeSentences(text);
    if(sentences.length === 0) return issues;

    sentences.forEach((sent, idx)=>{
      const n = idx + 1;
      const firstChar = sent[0];

      // hoofdletter check
      if(firstChar && firstChar === firstChar.toLowerCase() && /[a-z√†-√ø]/.test(firstChar)){
        issues.push({type:"capital", msg:`Zin ${n}: begin met een hoofdletter.`});
      }

      // eindpunt check
      if(!/[.!?]$/.test(sent)){
        issues.push({type:"punct", msg:`Zin ${n}: eindig met een punt, vraagteken of uitroepteken.`});
      }
    });

    // speciale check "beste jan"
    const lower = text.toLowerCase();
    const besteRegex = /beste\s+([a-z])(\w*)/g;
    let m;
    while((m = besteRegex.exec(lower)) !== null){
      const letter = m[1];
      const rest = m[2];
      const name = letter + rest;
      issues.push({
        type:"capital",
        msg:`Naam na "Beste" met hoofdletter schrijven, bijvoorbeeld: Beste ${name.charAt(0).toUpperCase()+name.slice(1)}.`
      });
    }

    return issues;
  }

  function calculateGrade(text, promptKey){
    const trimmed = text.trim();
    if(trimmed.length === 0) return null;

    const sentences = analyzeSentences(text);
    const words = trimmed.split(/\s+/).length;
    if(words < 5 || sentences.length === 0){
      return {grade:2.5, reason:"Schrijf eerst wat meer zinnen, dan kan ik je brief beter beoordelen."};
    }

    // Start op 10, trek punten af
    let grade = 10;

    // Fouten per zin
    let capErrors = 0;
    let punctErrors = 0;
    sentences.forEach(sent=>{
      const firstChar = sent[0];
      if(firstChar && firstChar === firstChar.toLowerCase() && /[a-z√†-√ø]/.test(firstChar)){
        capErrors++;
      }
      if(!/[.!?]$/.test(sent)){
        punctErrors++;
      }
    });

    // max 3 aftrek voor hoofdletters, max 3 voor eindpunten
    grade -= Math.min(3, capErrors);
    grade -= Math.min(3, punctErrors);

    const lower = trimmed.toLowerCase();

    // Checklist: begroeting, ik-ben, afsluiting
    const hasGreeting = /(^|\n)\s*(beste|hallo)\b/.test(lower);
    const hasIntroSelf = /(ik ben|ik heet|mijn naam)/.test(lower);
    const hasClosing = /(groetjes|met vriendelijke groet|vriendelijke groeten)/.test(lower);
    const enoughSentences = sentences.length >= 5;

    if(!hasGreeting) grade -= 1;
    if(!hasIntroSelf) grade -= 1;
    if(!hasClosing) grade -= 1;
    if(!enoughSentences) grade -= 1;

    // Inhoudscore per opdracht (√©cht minimaal iets over onderwerp)
    let keywords = [];
    if(promptKey === "vriend"){
      keywords = ["hobby","vriend","vriendin","samen","spelen","dag","avontuur","leuk","plezier"];
    }else if(promptKey === "juf"){
      keywords = ["klas","school","leren","uitleg","juf","meester","stil","rustig","druk","regels","huiswerk"];
    }else if(promptKey === "toekomst"){
      keywords = ["later","worden","beroep","droom","toekomst","hoop","wens","piloot","dokter","leraar","baan"];
    }

    let contentMatches = 0;
    keywords.forEach(k=>{
      if(lower.includes(k)) contentMatches++;
    });

    if(contentMatches === 0){
      grade -= 2;
    }else if(contentMatches < 2){
      grade -= 1;
    }

    // kleine bonus als alles netjes is
    if(capErrors === 0 && punctErrors === 0 && hasGreeting && hasIntroSelf && hasClosing && enoughSentences){
      grade += 0.5;
    }

    if(grade > 10) grade = 10;
    if(grade < 1) grade = 1;
    grade = Math.round(grade * 10) / 10;

    // korte reden
    let reason = "";
    if(capErrors > 0){
      reason = "Begin elke zin met een hoofdletter.";
    }else if(punctErrors > 0){
      reason = "Laat elke zin eindigen met een punt, vraagteken of uitroepteken.";
    }else if(!hasGreeting || !hasClosing){
      reason = "Zorg voor een nette beginzin en afsluiting.";
    }else if(contentMatches === 0){
      reason = "Schrijf meer over het onderwerp van de opdracht.";
    }else{
      reason = "Je brief is al netjes. Lees hem nog √©√©n keer rustig na.";
    }

    return {grade, reason};
  }

  function updateStats(){
    const text = letterText.value;
    const trimmed = text.trim();
    const words = trimmed.length===0 ? 0 : trimmed.split(/\s+/).length;
    const sentenceMatches = trimmed.match(/[.!?]/g) || [];
    const sentencesCount = sentenceMatches.length;
    const chars = text.length;
    const puncts = (text.match(/[.!?,;:!?]/g) || []).length;

    wordCount.textContent = words;
    sentenceCount.textContent = sentencesCount;
    charCount.textContent = chars;
    punctCount.textContent = puncts;

    const result = calculateGrade(text, currentPromptKey);
    if(!result){
      gradeEl.textContent = "‚Äì";
      feedback.innerHTML = '<span class="tag">üéì Feedback</span> Let op hoofdletters en punten in elke zin.';
    }else{
      gradeEl.textContent = result.grade.toFixed(1).replace('.',',');
      feedback.innerHTML = '<span class="tag">üéì Feedback</span> ' + result.reason;
    }

    // Issueslijst onder de brief
    const issues = buildIssues(text);
    if(issues.length === 0 || trimmed.length === 0){
      issuesBox.innerHTML = "";
    }else{
      let html = "<ul>";
      issues.forEach(i=>{
        const icon = i.type === "capital" ? "üîµ" : "üîµ";
        html += `<li>${icon} ${i.msg}</li>`;
      });
      html += "</ul>";
      issuesBox.innerHTML = html;
    }
  }

  letterText.addEventListener('input', updateStats);

  // --- Nieuwe brief ---
  document.getElementById('btnNew').addEventListener('click',()=>{
    if(letterText.value.trim().length>0){
      const ok = confirm("Nieuwe brief beginnen? Je tekst wordt gewist.");
      if(!ok) return;
    }
    letterText.value = "";
    updateStats();
    for(let i=1;i<=5;i++){
      const box=document.getElementById('cl'+i);
      if(box) box.checked=false;
    }
  });

  // --- Brief bewaren als plaatje (PNG op schriftpapier) ---
  document.getElementById('btnImage').addEventListener('click',()=>{
    const text = letterText.value.trim();
    if(!text){
      alert("Schrijf eerst je brief.");
      return;
    }

    const padding = 40;
    const width = 900;
    const lineHeight = 32;
    const title = "Mijn brief";

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    ctx.font = "20px system-ui, -apple-system, Segoe UI, Arial";

    function wrapText(text, maxWidth){
      const words = text.split(/\s+/);
      const lines = [];
      let current = "";
      for(let i=0;i<words.length;i++){
        const test = current ? current + " " + words[i] : words[i];
        const w = ctx.measureText(test).width;
        if(w > maxWidth && current){
          lines.push(current);
          current = words[i];
        }else{
          current = test;
        }
      }
      if(current) lines.push(current);
      return lines;
    }

    const allLines = [];
    allLines.push(title);
    allLines.push("");
    const paragraphs = text.split(/\n+/);
    paragraphs.forEach(p=>{
      const wrapped = wrapText(p, width - padding*2 - 40);
      if(wrapped.length === 0){
        allLines.push("");
      }else{
        wrapped.forEach(l=> allLines.push(l));
      }
      allLines.push("");
    });

    const height = padding*2 + allLines.length * lineHeight + 20;
    canvas.width = width;
    canvas.height = height;

    // Schriftpapier-achtergrond op canvas
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0,0,width,height);

    // Blauwe lijnen
    ctx.strokeStyle = "#e5e7eb";
    ctx.lineWidth = 1;
    const firstLineY = padding + 40;
    for(let y = firstLineY; y < height - padding; y += lineHeight){
      ctx.beginPath();
      ctx.moveTo(padding, y);
      ctx.lineTo(width - padding, y);
      ctx.stroke();
    }

    // Rode marge links
    ctx.strokeStyle = "#fecaca";
    ctx.lineWidth = 2;
    const marginX = padding + 20;
    ctx.beginPath();
    ctx.moveTo(marginX, padding);
    ctx.lineTo(marginX, height - padding);
    ctx.stroke();

    // Tekst
    ctx.fillStyle = "#0f172a";
    ctx.font = "26px system-ui, -apple-system, Segoe UI, Arial";
    ctx.fillText(title, padding, padding + lineHeight);

    ctx.font = "20px system-ui, -apple-system, Segoe UI, Arial";
    let y = padding + lineHeight*2;
    const textX = marginX + 12;

    for(let i=2;i<allLines.length;i++){
      const line = allLines[i];
      ctx.fillText(line, textX, y);
      y += lineHeight;
    }

    const dataURL = canvas.toDataURL("image/png");
    const a = document.createElement('a');
    a.href = dataURL;
    a.download = "mijn_brief.png";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    try{
      window.open(dataURL, "_blank");
    }catch(e){}
  });

  // Init stats
  updateStats();
</script>
</body>
</html>
